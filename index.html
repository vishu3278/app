<!doctype html>
<html>

<head>
    <title>DR Solution</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
    <!-- <link href="https://fonts.googleapis.com/css?family=Nunito:300,400,700&display=swap" rel="stylesheet"> -->
    <link href="https://fonts.googleapis.com/css?family=Oxanium:400,700|Spartan:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/bulma.min.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
    <!-- <script type="text/javascript" src="js/app.js"></script> -->
    <script type="text/javascript">
    function initdevice() {
        document.addEventListener("deviceready", onDeviceReady, false);
    }

    function onDeviceReady() {
        alert("device ready");
        checkConnection();
        document.addEventListener("offline", onOffline, false);
        document.addEventListener("online", onOnline, false);
        scannerPrepare();
    }

    function onOffline() {
        navigator.notification.alert("You lost connection!");
    }

    function onOnline() {
        navigator.vibrate([200, 400, 200]);
        navigator.notification.alert("You're connected");
    }

    function checkConnection() {
        var networkState = navigator.connection.type;

        var states = {};
        states[Connection.UNKNOWN] = 'Unknown connection';
        states[Connection.ETHERNET] = 'Ethernet connection';
        states[Connection.WIFI] = 'WiFi connection';
        states[Connection.CELL_2G] = 'Cell 2G connection';
        states[Connection.CELL_3G] = 'Cell 3G connection';
        states[Connection.CELL_4G] = 'Cell 4G connection';
        states[Connection.CELL] = 'Cell generic connection';
        states[Connection.NONE] = 'No network connection';

        $("#networkError").html(states[networkState]);
        // alert('Connection type: ' + states[networkState]);
        if (states[networkState] !== Connection.NONE) {
            navigator.vibrate([200, 400, 200]);
        } else {
            navigator.notification.alert("Connect to internet to proceed!");
        }
        return (states[networkState]);
    }

    function getHtml(arguments) {
        $.get(arguments, function(data) {
            $("#page").html(data);
            rotate();
        })
    }

    function scannerPrepare() {
        window.QRScanner.prepare(onDone); // show the prompt

        function onDone(err, status) {
            if (err) {
                // here we can handle errors and clean up any loose ends.
                console.error(err);
            }
            if (status.authorized) {
                // W00t, you have camera access and the scanner is initialized.
                QRscanner.show(); //should feel very fast.
            } else if (status.denied) {
                // The video preview will remain black, and scanning is disabled. We can
                // try to ask the user to change their mind, but we'll have to send them
                // to their device settings with `QRScanner.openSettings()`.
            } else {
                // we didn't get permission, but we didn't get permanently denied. (On
                // Android, a denial isn't permanent unless the user checks the "Don't
                // ask again" box.) We can ask again at the next relevant opportunity.

            }
        }
    }

    /*function scanQR(argument) {
        window.QRScanner.scan(displayContents);

        function displayContents(err, text) {
            if (err) {
                // an error occurred, or the scan was canceled (error code `6`)
            } else {
                // The scan completed, display the contents of the QR code:
                alert(text);
            }
        }
    }*/

    var scanOptions = {
        "preferFrontCamera": true, // iOS and Android
        "showFlipCameraButton": true, // iOS and Android
        "prompt": "Place a barcode inside the scan area", // supported on Android only
        "formats": "QR_CODE,PDF_417", // default: all but PDF_417 and RSS_EXPANDED
        "orientation": "landscape"
    };

    function scanQR(arguments) {
        alert("initiate");
        // console.log(cordova.plugins.barcodeScanner);
        cordova.plugins.barcodeScanner.scan(
            function(result) {
                alert(JSON.stringify(result));
                if (!result.cancelled) {
                    // In this case we only want to process QR Codes
                    if (result.format == "QR_CODE") {
                        var value = result.text;
                        // This is the retrieved content of the qr code
                        console.log(value);
                    } else {
                        alert("Sorry, only qr codes this time ;)");
                    }
                } else {
                    alert("The user has dismissed the scan");
                }
            },
            function(error) {
                alert("Scanning failed: " + error);
            },
            scanOptions
        );
    }

    function cameraGo(elem) {
        var options = {
            sourceType: Camera.PictureSourceType.CAMERA,
            //        sourceType:Camera.PictureSourceType.PHOTOLIBRARY,
            //        quality:50,
            destinationType: Camera.DestinationType.FILE_URI
        };

        navigator.camera.getPicture(successCallback, errorCallback, options);

        function successCallback(imageURI) {
            $("#capturi").html(imageURI);
            $("#capture").attr('src', imageURI);
        };

        function errorCallback(message) {
            alert(message);
        }
    }

    function cameraClean() {
        navigator.camera.cleanup(onSuccess, onFail);

        function onSuccess() {
            console.log("Camera cleanup success.")
        }

        function onFail(message) {
            alert('Failed because: ' + message);
        }
    }

    function rotate() {
        //    navigator.compass.getCurrentHeading(compassSuccess, compassError);

        var options = {
            frequency: 1000
        };

        function onSuccess(heading) {
            /*var element = document.getElementById('heading');
            element.innerHTML = 'Heading: ' + heading.magneticHeading;*/
            $("#magnet").html(heading.magneticHeading);
            $("#compass").css({ 'transform': 'rotate(' + heading.magneticHeading + 'deg)' });
        };

        function onError(compassError) {
            alert('Compass error: ' + compassError.code);
        };

        var watchID = navigator.compass.watchHeading(onSuccess, onError, options);
    }
    </script>
</head>

<body onload="initdevice()">
    <section class="hero is-bold is-danger">
        <div class="hero-body">
            <div class="container">
                <h1 class="title">
                    Dr Solution
                </h1>
                <h2 class="subtitle">
                    Scan card
                </h2>
            </div>
        </div>
    </section>
    <div class="container is-fluid">
        <div id="networkError" class="notification is-warning">
        </div>
        <div class="card">
            <div class="card-content">
                <p>Scan QR code using this app.</p>
                <!-- <button class="button is-primary">Scan</button> -->
            </div>
            <div >
                <button type="button" onclick="scanQR()" class="button">Scan</button>
                <button type="button" onclick="alert('Compass')" class="button">Compass</button>
                <button type="button" onclick="cameraGo()" class="button">Camera</button>
            </div>
        </div>
    </div>
    <div id="page"></div>
    <script type="text/javascript" src="cordova.js"></script>
</body>

</html>